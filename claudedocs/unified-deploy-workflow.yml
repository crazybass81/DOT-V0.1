name: Unified Deployment Pipeline
# DOT-V0.1 í†µí•© ë°°í¬ íŒŒì´í”„ë¼ì¸ - Solo Developer ìµœì í™”

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'claudedocs/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        default: false
        type: boolean
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rollback_mode:
        description: 'ë¡¤ë°± ëª¨ë“œ (ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬)'
        required: false
        default: false
        type: boolean
      target_version:
        description: 'ë¡¤ë°± ëŒ€ìƒ ë²„ì „ (ë¡¤ë°± ëª¨ë“œì¼ ë•Œë§Œ)'
        required: false
        default: 'previous'

env:
  NODE_VERSION: '20'
  REGISTRY: 'ghcr.io'
  PROJECT_NAME: 'dot-platform'

jobs:
  # Phase 1: í’ˆì§ˆ ê²€ì‚¬ (ë³‘ë ¬ ì‹¤í–‰, ë¹„ì°¨ë‹¨)
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_mode != 'true'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¦°íŒ… ì‹¤í–‰ (ë¹„ì°¨ë‹¨)
        continue-on-error: true
        run: |
          echo "ğŸ” ì½”ë“œ ë¦°íŒ… ì‹¤í–‰..."
          npm run lint --if-present || echo "âš ï¸ ë¦°íŒ… ê²½ê³  ë°œê²¬ (ê³„ì† ì§„í–‰)"

      - name: íƒ€ì… ì²´í¬ (ë¹„ì°¨ë‹¨)
        continue-on-error: true
        run: |
          echo "ğŸ” íƒ€ì… ì²´í¬ ì‹¤í–‰..."
          npm run typecheck --if-present || echo "âš ï¸ íƒ€ì… ì˜¤ë¥˜ ë°œê²¬ (ê³„ì† ì§„í–‰)"

  test-backend:
    name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true' && github.event.inputs.rollback_mode != 'true'

    services:
      postgres:
        image: postgis/postgis:15-3.3-alpine
        env:
          POSTGRES_DB: dot_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: cd backend && npm ci

      - name: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
        continue-on-error: true
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/dot_test
        run: |
          cd backend
          npx sequelize-cli db:migrate || echo "âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: ë°±ì—”ë“œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë¹„ì°¨ë‹¨)
        continue-on-error: true
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/dot_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
        run: |
          cd backend
          npm run test:unit -- --coverage || echo "âš ï¸ ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: backend/coverage/
          retention-days: 3

  test-frontend:
    name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true' && github.event.inputs.rollback_mode != 'true'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: cd frontend && npm ci

      - name: í”„ë¡ íŠ¸ì—”ë“œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë¹„ì°¨ë‹¨)
        continue-on-error: true
        run: |
          cd frontend
          npm run test -- --coverage --watchAll=false || echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ë¹„ì°¨ë‹¨)
        continue-on-error: true
        run: |
          cd frontend
          npm run build || echo "âš ï¸ ë¹Œë“œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: frontend/coverage/
          retention-days: 3

  # Phase 2: ë°±ì—”ë“œ ë¹Œë“œ (main ë¸Œëœì¹˜ë§Œ)
  build-backend:
    name: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: github.ref == 'refs/heads/main' && github.event.inputs.rollback_mode != 'true'

    outputs:
      backend-image: ${{ steps.meta.outputs.backend-image }}
      image-tag: ${{ steps.meta.outputs.image-tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ë©”íƒ€ë°ì´í„° ì„¤ì •
        id: meta
        run: |
          IMAGE_TAG="${{ github.sha }}"
          BACKEND_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}-backend:${IMAGE_TAG}"

          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "backend-image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT

          echo "ğŸ³ Backend ì´ë¯¸ì§€: ${BACKEND_IMAGE}"

      - name: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.backend-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  # Phase 3a: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (Vercel, main ë¸Œëœì¹˜ë§Œ)
  deploy-frontend:
    name: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (Vercel)
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: github.ref == 'refs/heads/main' && github.event.inputs.rollback_mode != 'true'

    outputs:
      deployment-url: ${{ steps.vercel-deploy.outputs.deployment-url }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Vercel CLI ì„¤ì¹˜
        run: npm install --global vercel@latest

      - name: Vercel í”„ë¡œë•ì…˜ ë°°í¬
        id: vercel-deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend

          echo "ğŸš€ Vercel í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN

          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          echo "deployment-url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ: ${DEPLOYMENT_URL}"

  # Phase 3b: ë°±ì—”ë“œ ë°°í¬ (EC2 Docker, main ë¸Œëœì¹˜ë§Œ)
  deploy-backend:
    name: ë°±ì—”ë“œ ë°°í¬ (EC2 Docker)
    runs-on: ubuntu-latest
    needs: [build-backend]
    if: github.ref == 'refs/heads/main' && github.event.inputs.rollback_mode != 'true'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: EC2 ì„œë²„ ë°°í¬
        run: |
          echo "ğŸš€ EC2 ë°±ì—”ë“œ ë°°í¬ ì‹œì‘..."

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > deploy-backend.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ğŸ“¦ Docker ì´ë¯¸ì§€: ${{ needs.build-backend.outputs.backend-image }}"

          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/${{ secrets.EC2_USER }}/DOT-V0.1 || {
            echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          }

          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git checkout main
          git pull origin main

          # GitHub Container Registry ë¡œê·¸ì¸
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "ğŸ›‘ ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€..."
          docker-compose -f docker-compose.prod.yml down || true

          # ìƒˆ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ ìƒˆ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°..."
          docker pull ${{ needs.build-backend.outputs.backend-image }}

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
          export BACKEND_IMAGE="${{ needs.build-backend.outputs.backend-image }}"
          docker-compose -f docker-compose.prod.yml up -d

          # í—¬ìŠ¤ì²´í¬
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°..."
          for i in {1..30}; do
            if curl -f http://localhost:3001/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘!"
              exit 0
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/30..."
            sleep 2
          done

          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          docker-compose -f docker-compose.prod.yml logs --tail=50
          exit 1
          EOF

          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' < deploy-backend.sh

      - name: ë°°í¬ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘..."

          # API í—¬ìŠ¤ì²´í¬
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3001/health)
            if [ "$response" = "200" ]; then
              echo "âœ… Backend API ì •ìƒ ì‘ë™"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ Backend API ì‘ë‹µ ì‹¤íŒ¨: $response"
              exit 1
            fi
            echo "API ê²€ì¦ ì‹œë„ $i/10..."
            sleep 3
          done

          # ë²„ì „ ì •ë³´ í™•ì¸
          version=$(curl -s http://${{ secrets.EC2_HOST }}:3001/version || echo "unknown")
          echo "ğŸ“Œ ë°°í¬ëœ ë²„ì „: $version"

  # Phase 3c: PR í”„ë¦¬ë·° ë°°í¬
  deploy-preview:
    name: PR í”„ë¦¬ë·° ë°°í¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Vercel CLI ì„¤ì¹˜
        run: npm install --global vercel@latest

      - name: Vercel í”„ë¦¬ë·° ë°°í¬
        id: vercel-preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend

          echo "ğŸ” PR í”„ë¦¬ë·° ë°°í¬ ì‹œì‘..."
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          vercel build --token=$VERCEL_TOKEN

          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN)
          echo "deployment-url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

          echo "âœ… í”„ë¦¬ë·° ë°°í¬ ì™„ë£Œ: ${DEPLOYMENT_URL}"

      - name: PRì— ë°°í¬ URL ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ steps.vercel-preview.outputs.deployment-url }}';
            const prNumber = context.issue.number;

            const comment = `
            ## ğŸš€ í”„ë¦¬ë·° ë°°í¬ ì™„ë£Œ!

            **í”„ë¦¬ë·° URL**: ${deploymentUrl}

            ### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸:
            - [ ] UI/UX ë³€ê²½ ì‚¬í•­ í™•ì¸
            - [ ] ê¸°ëŠ¥ ë™ì‘ í…ŒìŠ¤íŠ¸
            - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜• í™•ì¸
            - [ ] ì½˜ì†” ì˜¤ë¥˜ ì—†ìŒ í™•ì¸

            ---
            *ìƒˆ ì»¤ë°‹ í‘¸ì‹œ ì‹œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*
            `;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Phase 4: ë°°í¬ í›„ ê²€ì¦ ë° ëª¨ë‹ˆí„°ë§
  post-deploy-validation:
    name: ë°°í¬ í›„ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: github.ref == 'refs/heads/main' && github.event.inputs.rollback_mode != 'true' && always()

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í†µí•© í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ” í†µí•© ì‹œìŠ¤í…œ ê²€ì¦ ì‹œì‘..."

          # í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦
          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            frontend_url="${{ needs.deploy-frontend.outputs.deployment-url }}"
            echo "Frontend URL: ${frontend_url}"

            response=$(curl -s -o /dev/null -w "%{http_code}" "${frontend_url}")
            if [ "$response" = "200" ]; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì •ìƒ"
            else
              echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì‘ë‹µ ì´ìƒ: $response"
            fi
          fi

          # ë°±ì—”ë“œ ê²€ì¦
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            backend_url="http://${{ secrets.EC2_HOST }}:3001"
            echo "Backend URL: ${backend_url}"

            response=$(curl -s -o /dev/null -w "%{http_code}" "${backend_url}/health")
            if [ "$response" = "200" ]; then
              echo "âœ… ë°±ì—”ë“œ ì •ìƒ"
            else
              echo "âš ï¸ ë°±ì—”ë“œ ì‘ë‹µ ì´ìƒ: $response"
            fi
          fi

      - name: ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ê²€ì¦ (í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­)
        run: |
          echo "ğŸ¯ ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ê²€ì¦ (<3ì´ˆ ë¡œë”©)"

          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            frontend_url="${{ needs.deploy-frontend.outputs.deployment-url }}"

            response_time=$(curl -o /dev/null -s -w '%{time_total}' "${frontend_url}")
            echo "í˜ì´ì§€ ë¡œë”© ì‹œê°„: ${response_time}ì´ˆ"

            if (( $(echo "$response_time < 3.0" | bc -l) )); then
              echo "âœ… ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ë§Œì¡± (<3ì´ˆ)"
            else
              echo "âš ï¸ ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ë¯¸ë‹¬: ${response_time}ì´ˆ (ëª©í‘œ: <3ì´ˆ)"
            fi
          fi

  # Phase 5: ë°°í¬ íƒœê·¸ ìƒì„± (ë¡¤ë°±ìš©)
  create-deployment-tag:
    name: ë°°í¬ íƒœê·¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, post-deploy-validation]
    if: github.ref == 'refs/heads/main' && success() && github.event.inputs.rollback_mode != 'true'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬ íƒœê·¸ ìƒì„±
        run: |
          TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git tag -a "$TAG_NAME" -m "Production deployment - $(date '+%Y-%m-%d %H:%M:%S')

          Frontend: ${{ needs.deploy-frontend.outputs.deployment-url }}
          Backend: ${{ needs.build-backend.outputs.backend-image }}
          Commit: ${{ github.sha }}"

          git push origin "$TAG_NAME" || echo "Tag push failed (permissions)"

          echo "âœ… ë°°í¬ íƒœê·¸ ìƒì„±: $TAG_NAME"

  # ë¡¤ë°± ì‘ì—… (ìˆ˜ë™ íŠ¸ë¦¬ê±°)
  rollback:
    name: ì´ì „ ë²„ì „ ë¡¤ë°±
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_mode == 'true'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ë°±ì—”ë“œ ë¡¤ë°±
        run: |
          echo "ğŸ”„ ë°±ì—”ë“œ ë¡¤ë°± ì‹œì‘..."

          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/${{ secrets.EC2_USER }}/DOT-V0.1

            # ì´ì „ Docker ì´ë¯¸ì§€ íƒœê·¸ ì°¾ê¸°
            prev_tag=$(docker images --format "{{.Tag}}" | grep -E '^[a-f0-9]{40}$' | head -n 2 | tail -n 1)

            if [ -n "$prev_tag" ]; then
              echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±: $prev_tag"

              # í˜„ì¬ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
              docker-compose -f docker-compose.prod.yml down

              # ì´ì „ ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘
              export BACKEND_IMAGE="ghcr.io/${{ github.repository }}-backend:$prev_tag"
              docker-compose -f docker-compose.prod.yml up -d

              # í—¬ìŠ¤ì²´í¬
              sleep 10
              if curl -f http://localhost:3001/health > /dev/null 2>&1; then
                echo "âœ… ë¡¤ë°± ì™„ë£Œ - ì„œë¹„ìŠ¤ ì •ìƒ"
              else
                echo "âŒ ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                exit 1
              fi
            else
              echo "âš ï¸ ë¡¤ë°±í•  ì´ì „ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              exit 1
            fi
          EOF

      - name: í”„ë¡ íŠ¸ì—”ë“œ ë¡¤ë°±
        run: |
          echo "ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ ë¡¤ë°± ì‹œì‘..."

          npm install --global vercel@latest

          # ì´ì „ ë°°í¬ ì°¾ê¸° ë° í”„ë¡œëª¨ì…˜
          cd frontend
          vercel login --token ${{ secrets.VERCEL_TOKEN }}

          # ì´ì „ ë°°í¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          deployments=$(vercel ls --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }})
          echo "ì´ì „ ë°°í¬ ëª©ë¡ ì¡°íšŒ ì™„ë£Œ"

          echo "âš ï¸ ìˆ˜ë™ìœ¼ë¡œ Vercel ëŒ€ì‹œë³´ë“œì—ì„œ ì´ì „ ë°°í¬ë¥¼ í”„ë¡œëª¨ì…˜í•˜ì„¸ìš”"

  # ìµœì¢… ì•Œë¦¼
  notify-deployment:
    name: ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, post-deploy-validation, create-deployment-tag]
    if: always() && github.ref == 'refs/heads/main' && github.event.inputs.rollback_mode != 'true'

    steps:
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: needs.deploy-frontend.result == 'success' && needs.deploy-backend.result == 'success'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_MESSAGE: |
            ğŸ‰ DOT Platform í†µí•© ë°°í¬ ì„±ê³µ!

            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            **Frontend**: ${{ needs.deploy-frontend.outputs.deployment-url }}
            **Backend**: http://${{ secrets.EC2_HOST }}:3001

            âœ… ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy-frontend.result == 'failure' || needs.deploy-backend.result == 'failure'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_MESSAGE: |
            âŒ DOT Platform ë°°í¬ ì‹¤íŒ¨!

            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            **Frontend**: ${{ needs.deploy-frontend.result }}
            **Backend**: ${{ needs.deploy-backend.result }}

            ğŸ” GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.