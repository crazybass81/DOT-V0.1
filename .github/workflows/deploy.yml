name: DOT Platform ë°°í¬ ë° ê²€ì¦ (í†µí•© ë²„ì „)

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬í•  ë²„ì „ íƒœê·¸'
        required: false
        default: 'latest'
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      validation_mode:
        description: 'ê²€ì¦ ëª¨ë“œ'
        required: true
        default: 'full'
        type: choice
        options:
          - health
          - smoke
          - functional
          - performance
          - full
      skip_validation:
        description: 'ë°°í¬ ê²€ì¦ ê±´ë„ˆë›°ê¸°'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dot-platform
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° ë¹Œë“œ ì¤€ë¹„
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¦°íŒ… ì‹¤í–‰
        run: npm run lint --if-present

      - name: íƒ€ì… ì²´í¬
        run: npm run typecheck --if-present

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        run: npm run test:unit --if-present

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/

  # 2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ (Docker Compose ê¸°ë°˜)
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name != 'pull_request'

    outputs:
      backend-image: ${{ steps.meta.outputs.backend-image }}
      frontend-image: ${{ steps.meta.outputs.frontend-image }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [[ "$VERSION" == "refs/heads/main" ]]; then
            VERSION="latest"
          elif [[ "$VERSION" == refs/heads/* ]]; then
            VERSION=${VERSION#refs/heads/}
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "backend-image=${{ env.REGISTRY }}/${{ github.repository }}-backend:$VERSION" >> $GITHUB_OUTPUT
          echo "frontend-image=${{ env.REGISTRY }}/${{ github.repository }}-frontend:$VERSION" >> $GITHUB_OUTPUT

      - name: ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.backend-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta.outputs.frontend-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3ë‹¨ê³„: Staging í™˜ê²½ ë°°í¬ (Docker Compose ê¸°ë°˜)
  deploy-staging:
    name: Staging ë°°í¬ ë° ê²€ì¦
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: staging

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬ ì„œë²„ SSH ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Staging ì„œë²„ ë°°í¬ (ê²€ì¦ í¬í•¨)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            cd ${{ secrets.STAGING_PATH }}
            git pull origin main

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export BACKEND_IMAGE="${{ needs.build.outputs.backend-image }}"
            export FRONTEND_IMAGE="${{ needs.build.outputs.frontend-image }}"
            export VALIDATION_MODE="${{ github.event.inputs.validation_mode || 'smoke' }}"
            export SKIP_VALIDATION="${{ github.event.inputs.skip_validation || 'false' }}"

            # DOT Platform ë°°í¬ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            ./scripts/deploy.sh ${{ needs.build.outputs.version }} staging
          EOF

      - name: Staging ë°°í¬ ê²€ì¦ ê²°ê³¼ ìˆ˜ì§‘
        run: |
          # í—¬ìŠ¤ì²´í¬ í™•ì¸
          curl -f http://${{ secrets.STAGING_HOST }}/health

          # ê²€ì¦ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
          scp ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:${{ secrets.STAGING_PATH }}/validation-reports/*.json . || true

          # ë°°í¬ ë¡œê·¸ ìˆ˜ì§‘
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "cd ${{ secrets.STAGING_PATH }} && docker-compose -f docker-compose.prod.yml logs --tail=100" \
            > staging-deploy-logs.txt

      - name: ê²€ì¦ ê²°ê³¼ ë° ë¡œê·¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: staging-validation-results
          path: |
            *.json
            staging-deploy-logs.txt

  # 4ë‹¨ê³„: í†µí•© í…ŒìŠ¤íŠ¸ (Staging í™˜ê²½ì—ì„œ ì‹¤ì œ ê²€ì¦)
  integration-test:
    name: í†µí•© í…ŒìŠ¤íŠ¸ ë° ì„±ëŠ¥ ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps

      - name: E2E ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          E2E_BASE_URL: http://${{ secrets.STAGING_HOST }}
          E2E_TIMEOUT: 60000
        run: |
          npm run test:e2e:smoke --if-present || echo "E2E ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"

      - name: ì ‘ê·¼ì„± ê²€ì¦ (DOT Platform ê²€ì¦ ì¸í”„ë¼)
        env:
          TARGET_URL: http://${{ secrets.STAGING_HOST }}
        run: |
          node tests/deployment/accessibility/a11y-check.js --url $TARGET_URL --timeout 120 || echo "ì ‘ê·¼ì„± ê²€ì¦ ê²½ê³ "

      - name: ë‹¤êµ­ì–´ ì§€ì› ê²€ì¦ (í•œ/ì˜/ì¼/ì¤‘)
        env:
          TARGET_URL: http://${{ secrets.STAGING_HOST }}
        run: |
          node tests/deployment/i18n/language-check.js --url $TARGET_URL --languages ko,en,ja,zh || echo "ë‹¤êµ­ì–´ ê²€ì¦ ê²½ê³ "

      - name: K6 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­ ê²€ì¦)
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/performance/k6-load-test.js
        env:
          BASE_URL: http://${{ secrets.STAGING_HOST }}

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            playwright-report/
            validation-reports/

  # 5ë‹¨ê³„: Production ë°°í¬ (íƒœê·¸ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰)
  deploy-production:
    name: Production ë°°í¬ ë° ê²€ì¦
    runs-on: ubuntu-latest
    needs: [build, integration-test]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Production ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸°
        uses: trstringer/manual-approval@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ secrets.PRODUCTION_APPROVERS }}
          minimum-approvals: 2
          issue-title: "ğŸš€ Production ë°°í¬ ìŠ¹ì¸ ìš”ì²­ - ${{ needs.build.outputs.version }}"
          issue-body: |
            ## DOT Platform Production ë°°í¬ ìŠ¹ì¸ ìš”ì²­

            **ë²„ì „**: ${{ needs.build.outputs.version }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            ### âœ… ì™„ë£Œëœ ê²€ì¦ ë‹¨ê³„
            - [x] ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¦°íŒ…, íƒ€ì…ì²´í¬, ë‹¨ìœ„í…ŒìŠ¤íŠ¸)
            - [x] Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
            - [x] Staging í™˜ê²½ ë°°í¬ ë° ê¸°ë³¸ ê²€ì¦
            - [x] í†µí•© í…ŒìŠ¤íŠ¸ (E2E, ì ‘ê·¼ì„±, ë‹¤êµ­ì–´, ì„±ëŠ¥)

            ### ğŸ¯ ë°°í¬ ê²€ì¦ ê³„íš
            - **í™˜ê²½**: Production
            - **ê²€ì¦ ëª¨ë“œ**: ${{ github.event.inputs.validation_mode || 'full' }}
            - **í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­**: < 3ì´ˆ í˜ì´ì§€ ë¡œë”©, 10ëª… ë™ì‹œ ì‚¬ìš©ì ì§€ì›
            - **ë¡¤ë°± ì •ì±…**: ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°± í™œì„±í™”

            **âš ï¸ ìŠ¹ì¸ í›„ ì¦‰ì‹œ ìë™ ë°°í¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤.**

      - name: ë°°í¬ ì„œë²„ SSH ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Production ì„œë²„ ë°°í¬ (ì „ì²´ ê²€ì¦ í¬í•¨)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ secrets.PRODUCTION_PATH }}
            git pull origin main

            # Production ë°°í¬ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export BACKEND_IMAGE="${{ needs.build.outputs.backend-image }}"
            export FRONTEND_IMAGE="${{ needs.build.outputs.frontend-image }}"
            export VALIDATION_MODE="${{ github.event.inputs.validation_mode || 'full' }}"
            export SKIP_VALIDATION="${{ github.event.inputs.skip_validation || 'false' }}"
            export ROLLBACK_ON_VALIDATION_FAILURE="true"

            # DOT Platform ë°°í¬ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í†µí•© ë²„ì „)
            ./scripts/deploy.sh ${{ needs.build.outputs.version }} production
          EOF

      - name: Production ë°°í¬ ê²€ì¦ ì™„ë£Œ í™•ì¸
        run: |
          # Production í™˜ê²½ í—¬ìŠ¤ì²´í¬
          curl -f http://${{ secrets.PRODUCTION_HOST }}/health

          # í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­ ë¹ ë¥¸ ê²€ì¦
          response_time=$(curl -o /dev/null -s -w '%{time_total}' http://${{ secrets.PRODUCTION_HOST }}/)
          echo "í˜ì´ì§€ ë¡œë”© ì‹œê°„: ${response_time}ì´ˆ"

          # ê²€ì¦ ë¦¬í¬íŠ¸ í™•ì¸
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "cd ${{ secrets.PRODUCTION_PATH }} && ls -la validation-reports/ && echo 'ê²€ì¦ ì™„ë£Œ'"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            ğŸš€ DOT Platform Production ë°°í¬ ì™„ë£Œ!

            **ë²„ì „**: ${{ needs.build.outputs.version }}
            **í™˜ê²½**: Production
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}
            **ê²€ì¦ ëª¨ë“œ**: ${{ github.event.inputs.validation_mode || 'full' }}

            âœ… ëª¨ë“  ë°°í¬ ê²€ì¦ ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤.
            ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­ (< 3ì´ˆ, 10ëª… ë™ì‹œ ì‚¬ìš©ì) ì¶©ì¡±

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_MESSAGE: |
            âŒ DOT Platform Production ë°°í¬ ì‹¤íŒ¨!

            **ë²„ì „**: ${{ needs.build.outputs.version }}
            **í™˜ê²½**: Production
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            ğŸ”„ ìë™ ë¡¤ë°±ì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            ğŸ“‹ ê²€ì¦ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”.

  # 6ë‹¨ê³„: ë°°í¬ í›„ ì§€ì†ì  ëª¨ë‹ˆí„°ë§
  post-deployment-monitoring:
    name: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 5ë¶„ê°„ ì§€ì†ì  ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ğŸ” Production í™˜ê²½ 5ë¶„ê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."

          for i in {1..10}; do
            echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ $i/10 (30ì´ˆ ê°„ê²©)"

            # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
            if ! curl -f http://${{ secrets.PRODUCTION_HOST }}/health; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì¦‰ì‹œ ì•Œë¦¼"
              exit 1
            fi

            # í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­ ì‘ë‹µ ì‹œê°„ ì²´í¬
            response_time=$(curl -o /dev/null -s -w '%{time_total}' http://${{ secrets.PRODUCTION_HOST }}/)
            if (( $(echo "$response_time > 3.0" | bc -l) )); then
              echo "âš ï¸ ì‘ë‹µì‹œê°„ ì§€ì—°: ${response_time}ì´ˆ (í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­: < 3ì´ˆ)"
            else
              echo "âœ… ì‘ë‹µì‹œê°„ ì •ìƒ: ${response_time}ì´ˆ"
            fi

            # ìƒì„¸ í—¬ìŠ¤ì²´í¬
            curl -s http://${{ secrets.PRODUCTION_HOST }}/health/detailed | jq . || echo "ìƒì„¸ í—¬ìŠ¤ì²´í¬ ì •ë³´ ì—†ìŒ"

            sleep 30
          done

          echo "âœ… 5ë¶„ê°„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ - ì‹œìŠ¤í…œ ì•ˆì •"

      - name: ìµœì¢… ê²€ì¦ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "cd ${{ secrets.PRODUCTION_PATH }} && ./scripts/generate-final-report.sh --deployment-id ${{ github.run_id }} --version ${{ needs.build.outputs.version }}" || echo "ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"

      - name: ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ë° ì„±ê³µ ì•Œë¦¼
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            âœ… DOT Platform ë°°í¬ ë° ëª¨ë‹ˆí„°ë§ ì™„ë£Œ!

            **ë²„ì „**: ${{ needs.build.outputs.version }}
            **ë°°í¬ ID**: ${{ github.run_id }}
            **ëª¨ë‹ˆí„°ë§**: 5ë¶„ê°„ ì•ˆì •ì„± í™•ì¸ ì™„ë£Œ

            ğŸ¯ ëª¨ë“  í•œêµ­ì–´ ìš”êµ¬ì‚¬í•­ì´ ì¶©ì¡±ë˜ì—ˆìŠµë‹ˆë‹¤.
            ğŸš€ ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤.