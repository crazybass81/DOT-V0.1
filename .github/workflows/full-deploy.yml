name: í†µí•© ìë™ ë°°í¬ (Frontend + Backend)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Frontend ë°°í¬ ì—¬ë¶€'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Backend ë°°í¬ ì—¬ë¶€'
        required: true
        default: true
        type: boolean

jobs:
  # ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test-all:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì „ì²´ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm run install:all

      - name: Frontend í…ŒìŠ¤íŠ¸
        run: |
          cd frontend
          npm run test -- --watchAll=false --coverage || true

      - name: Backend í…ŒìŠ¤íŠ¸
        run: |
          cd backend
          npm run test -- --coverage || true

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            frontend/coverage/
            backend/coverage/

  # Frontend ë°°í¬ (Vercel)
  deploy-frontend:
    name: Frontend ë°°í¬ (Vercel)
    runs-on: ubuntu-latest
    needs: test-all
    if: github.event.inputs.deploy_frontend != 'false'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Vercel ë°°í¬ íŠ¸ë¦¬ê±°
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./frontend

  # Backend ë°°í¬ (EC2 Docker)
  deploy-backend:
    name: Backend ë°°í¬ (EC2)
    runs-on: ubuntu-latest
    needs: test-all
    if: github.event.inputs.deploy_backend != 'false'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          cd backend
          docker build -t dot-backend:${{ github.sha }} .

      - name: Docker ì´ë¯¸ì§€ ì €ì¥
        run: |
          docker save dot-backend:${{ github.sha }} | gzip > backend-image.tar.gz

      - name: EC2ë¡œ ì´ë¯¸ì§€ ì „ì†¡ ë° ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ì§€
            docker-compose -f /home/ubuntu/dot-platform/docker-compose.prod.yml down || true

            # ìƒˆ ì´ë¯¸ì§€ ë¡œë“œ
            docker load < backend-image.tar.gz

            # í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            export BACKEND_IMAGE=dot-backend:${{ github.sha }}

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose -f /home/ubuntu/dot-platform/docker-compose.prod.yml up -d

            # í—¬ìŠ¤ì²´í¬
            sleep 10
            curl -f http://localhost:3001/health || exit 1

            echo "âœ… Backend ë°°í¬ ì™„ë£Œ!"

  # ë°°í¬ í›„ í†µí•© ê²€ì¦
  verify-deployment:
    name: ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()

    steps:
      - name: Frontend ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ” Frontend ê²€ì¦ ì¤‘..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://dot-platform.vercel.app)
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend ì •ìƒ ì‘ë™"
          else
            echo "âŒ Frontend ì‘ë‹µ ì˜¤ë¥˜: $response"
            exit 1
          fi

      - name: Backend API ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ” Backend ê²€ì¦ ì¤‘..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3001/health)
          if [ "$response" = "200" ]; then
            echo "âœ… Backend API ì •ìƒ ì‘ë™"
          else
            echo "âŒ Backend API ì‘ë‹µ ì˜¤ë¥˜: $response"
            exit 1
          fi

      - name: Frontend-Backend ì—°ë™ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ” í†µí•© ì—°ë™ í…ŒìŠ¤íŠ¸..."
          # API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (ì˜ˆ: ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸)
          curl -X POST http://${{ secrets.EC2_HOST }}:3001/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"test"}' \
            -w "\nì‘ë‹µ ì½”ë“œ: %{http_code}\n" || true

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        uses: rtCamp/action-slack-notify@v2
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_MESSAGE: |
            ğŸ‰ í†µí•© ë°°í¬ ì„±ê³µ!

            **Frontend**: https://dot-platform.vercel.app
            **Backend**: http://${{ secrets.EC2_HOST }}:3001
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.