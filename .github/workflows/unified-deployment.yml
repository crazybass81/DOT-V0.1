name: Unified Deployment Pipeline
# DOT-V0.1 í†µí•© ë°°í¬ íŒŒì´í”„ë¼ì¸ - Solo Developer ìµœì í™”

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'claudedocs/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        default: false
        type: boolean
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'
  PROJECT_NAME: 'dot-platform'

jobs:
  # Phase 1: í”„ë¡ íŠ¸ì—”ë“œ Vercel ë°°í¬
  deploy-frontend:
    name: Frontend ë°°í¬ (Vercel)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    outputs:
      deployment-url: ${{ steps.vercel-deploy.outputs.deployment-url }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Vercel CLI ì„¤ì¹˜
        run: npm install --global vercel@latest

      - name: Vercel í”„ë¡œë•ì…˜ ë°°í¬
        id: vercel-deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸš€ Vercel í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘..."

          # í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ (vercel.jsonì´ ìˆëŠ” ìœ„ì¹˜)
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN

          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          echo "deployment-url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

          echo "âœ… Frontend ë°°í¬ ì™„ë£Œ: ${DEPLOYMENT_URL}"

  # Phase 2: ë°±ì—”ë“œ EC2 ë°°í¬
  deploy-backend:
    name: Backend ë°°í¬ (EC2 Docker)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: EC2 ì„œë²„ì— SSH ì—°ê²° ë° ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Backend ë°°í¬ ì‹œì‘..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.EC2_USER }}/DOT-V0.1 || exit 1

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git checkout main
            git pull origin main

            # Docker Composeë¡œ ë°±ì—”ë“œ ì¬ì‹œì‘
            echo "ğŸ”„ Docker ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build

            # í—¬ìŠ¤ì²´í¬
            echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°..."
            sleep 10

            if curl -f http://localhost:3001/health > /dev/null 2>&1; then
              echo "âœ… Backend ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘!"
            else
              echo "âŒ Backend í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi

  # Phase 3: PR í”„ë¦¬ë·° ë°°í¬
  deploy-preview:
    name: PR í”„ë¦¬ë·° ë°°í¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Vercel CLI ì„¤ì¹˜
        run: npm install --global vercel@latest

      - name: Vercel í”„ë¦¬ë·° ë°°í¬
        id: vercel-preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸ” PR í”„ë¦¬ë·° ë°°í¬ ì‹œì‘..."

          # í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          vercel build --token=$VERCEL_TOKEN

          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN)
          echo "deployment-url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

          echo "âœ… í”„ë¦¬ë·° ë°°í¬ ì™„ë£Œ: ${DEPLOYMENT_URL}"

      - name: PRì— ë°°í¬ URL ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ steps.vercel-preview.outputs.deployment-url }}';
            const prNumber = context.issue.number;

            const comment = `
            ## ğŸš€ í”„ë¦¬ë·° ë°°í¬ ì™„ë£Œ!

            **í”„ë¦¬ë·° URL**: ${deploymentUrl}

            ### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸:
            - [ ] UI/UX ë³€ê²½ ì‚¬í•­ í™•ì¸
            - [ ] ê¸°ëŠ¥ ë™ì‘ í…ŒìŠ¤íŠ¸
            - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜• í™•ì¸
            - [ ] ì½˜ì†” ì˜¤ë¥˜ ì—†ìŒ í™•ì¸

            ---
            *ìƒˆ ì»¤ë°‹ í‘¸ì‹œ ì‹œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*
            `;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Phase 4: ë°°í¬ í›„ ê²€ì¦
  post-deploy-validation:
    name: ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: github.ref == 'refs/heads/main' && always()

    steps:
      - name: Frontend í—¬ìŠ¤ì²´í¬
        if: needs.deploy-frontend.result == 'success'
        run: |
          echo "ğŸ” Frontend ê²€ì¦..."
          frontend_url="${{ needs.deploy-frontend.outputs.deployment-url }}"

          response=$(curl -s -o /dev/null -w "%{http_code}" "${frontend_url}")
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend ì •ìƒ (HTTP $response)"
          else
            echo "âš ï¸ Frontend ì‘ë‹µ ì´ìƒ: HTTP $response"
          fi

          # ì„±ëŠ¥ ê²€ì¦ (<3ì´ˆ)
          response_time=$(curl -o /dev/null -s -w '%{time_total}' "${frontend_url}")
          echo "ğŸ“Š í˜ì´ì§€ ë¡œë”© ì‹œê°„: ${response_time}ì´ˆ"

          if (( $(echo "$response_time < 3.0" | bc -l) )); then
            echo "âœ… ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ë§Œì¡± (<3ì´ˆ)"
          else
            echo "âš ï¸ ì„±ëŠ¥ ê°œì„  í•„ìš”: ${response_time}ì´ˆ (ëª©í‘œ: <3ì´ˆ)"
          fi

      - name: Backend í—¬ìŠ¤ì²´í¬
        if: needs.deploy-backend.result == 'success'
        run: |
          echo "ğŸ” Backend ê²€ì¦..."
          backend_url="http://${{ secrets.EC2_HOST }}:3001"

          response=$(curl -s -o /dev/null -w "%{http_code}" "${backend_url}/health")
          if [ "$response" = "200" ]; then
            echo "âœ… Backend API ì •ìƒ (HTTP $response)"

            # ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            health_data=$(curl -s "${backend_url}/health")
            echo "ğŸ“Š Backend ìƒíƒœ: ${health_data}"
          else
            echo "âš ï¸ Backend API ì‘ë‹µ ì´ìƒ: HTTP $response"
          fi

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "========================================="
          echo "ğŸ‰ DOT Platform ë°°í¬ ì™„ë£Œ!"
          echo "========================================="
          echo "Frontend: ${{ needs.deploy-frontend.outputs.deployment-url }}"
          echo "Backend: http://${{ secrets.EC2_HOST }}:3001"
          echo "========================================="