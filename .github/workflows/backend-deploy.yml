name: Backend ìë™ ë°°í¬ (EC2 Docker)

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - 'docker-compose.prod.yml'
      - 'Dockerfile*'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-backend

jobs:
  build-and-push:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy-to-ec2:
    name: EC2 ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: EC2 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
        run: |
          cat > deploy-script.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ğŸš€ DOT Platform Backend ë°°í¬ ì‹œì‘..."

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DOCKER_IMAGE="${{ needs.build-and-push.outputs.image-tag }}"
          export ENVIRONMENT="${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"

          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/dot-platform || {
            echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤..."
            git clone https://github.com/${{ github.repository }}.git /home/ubuntu/dot-platform
            cd /home/ubuntu/dot-platform
          }

          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}

          # í™˜ê²½ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          # Docker ë¡œê·¸ì¸
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
          docker-compose -f docker-compose.prod.yml down || true

          # ìƒˆ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¦ ìƒˆ Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°..."
          docker pull $DOCKER_IMAGE

          # ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
          docker-compose -f docker-compose.prod.yml up -d

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 10

          # í—¬ìŠ¤ì²´í¬
          for i in {1..30}; do
            if curl -f http://localhost:3001/health > /dev/null 2>&1; then
              echo "âœ… Backend ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/30..."
            sleep 2
          done

          # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
          docker image prune -af --filter "until=24h"

          echo "âœ¨ ë°°í¬ ì™„ë£Œ!"
          EOF

      - name: SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: EC2 ì„œë²„ì— ë°°í¬
        run: |
          # SSH ì—°ê²° ë° ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' < deploy-script.sh

      - name: ë°°í¬ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘..."

          # API í—¬ìŠ¤ì²´í¬
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3001/health)
          if [ "$response" = "200" ]; then
            echo "âœ… Backend API ì •ìƒ ì‘ë™ ì¤‘"
          else
            echo "âŒ Backend API ì‘ë‹µ ì˜¤ë¥˜: $response"
            exit 1
          fi

          # ë²„ì „ í™•ì¸
          version=$(curl -s http://${{ secrets.EC2_HOST }}:3001/version || echo "unknown")
          echo "ğŸ“Œ ë°°í¬ëœ ë²„ì „: $version"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        uses: rtCamp/action-slack-notify@v2
        if: success() && env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_MESSAGE: |
            ğŸ‰ Backend EC2 ë°°í¬ ì„±ê³µ!

            **í™˜ê²½**: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}
            **Docker ì´ë¯¸ì§€**: ${{ needs.build-and-push.outputs.image-tag }}
            **ì„œë²„**: ${{ secrets.EC2_HOST }}

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        uses: rtCamp/action-slack-notify@v2
        if: failure() && env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_MESSAGE: |
            âŒ Backend EC2 ë°°í¬ ì‹¤íŒ¨!

            **í™˜ê²½**: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë°°í¬ì**: ${{ github.actor }}

            EC2 ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.

  rollback:
    name: ë¡¤ë°± (ì‹¤íŒ¨ ì‹œ)
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-to-ec2]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: SSH í‚¤ ì„¤ì •
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
        run: |
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/dot-platform

            # ì´ì „ íƒœê·¸ë¡œ ë¡¤ë°±
            prev_tag=$(docker images --format "{{.Tag}}" | grep -v latest | head -n 2 | tail -n 1)
            if [ -n "$prev_tag" ]; then
              echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±: $prev_tag"
              docker-compose -f docker-compose.prod.yml down
              export DOCKER_IMAGE="ghcr.io/${{ github.repository }}-backend:$prev_tag"
              docker-compose -f docker-compose.prod.yml up -d
              echo "âœ… ë¡¤ë°± ì™„ë£Œ"
            else
              echo "âš ï¸ ë¡¤ë°±í•  ì´ì „ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            fi
          EOF